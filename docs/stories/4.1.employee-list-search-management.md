# Story 4.1: Employee List & Search Management (จัดการรายชื่อพนักงานและการค้นหา)

## Status
Completed ✅

## Story
**As a** Admin ของระบบบริหารจัดการพนักงาน,  
**I want** หน้าแสดงรายชื่อพนักงานทั้งหมดพร้อมระบบค้นหาและกรองข้อมูล,  
**so that** ฉันสามารถดูข้อมูลพนักงานทั้งหมด ค้นหาพนักงานที่ต้องการ และจัดการข้อมูลได้อย่างมีประสิทธิภาพ

## Acceptance Criteria
1. Admin สามารถเข้าถึงหน้า "จัดการพนักงาน" ได้จาก admin dashboard navigation
2. ระบบแสดงรายชื่อพนักงานทั้งหมดในรูปแบบตาราง (table format)
3. แสดงข้อมูลในแต่ละรายการ: ชื่อ-สกุล, อีเมล, สาขาหลัก, บทบาท (employee/admin), สถานะ (active/inactive)
4. มีฟังก์ชันค้นหา (search) ตามชื่อหรืออีเมล แบบ real-time
5. มีตัวกรอง (filter) ตามสาขา, บทบาท, และสถานะ
6. มีการเรียงลำดับ (sort) ตามชื่อ, อีเมล, และวันที่สร้างบัญชี
7. ใช้ pagination สำหรับข้อมูลจำนวนมาก (แสดง 20 รายการต่อหน้า)
8. แสดง loading state ขณะดึงข้อมูล และ error handling หากมีปัญหา
9. มีปุ่ม "เพิ่มพนักงานใหม่" สำหรับไปหน้า Story 4.2
10. Responsive design สำหรับ desktop และ tablet (mobile ไม่จำเป็นสำหรับ admin function)

## Tasks / Subtasks
- [x] Task 1: สร้าง Employee Management API Endpoints (AC: 2, 3, 7) ✅
  - [x] สร้าง GET /api/admin/employees - ดึงรายชื่อพนักงานทั้งหมด
  - [x] รับ query parameters: search, branchId, role, status, page, limit
  - [x] JOIN กับ branches table เพื่อดึงชื่อสาขา
  - [x] เพิ่ม pagination และ total count ใน response
  - [x] ใช้ WHERE clause สำหรับ search และ filter

- [x] Task 2: สร้าง Employee Service Layer (AC: 2, 4, 5, 6) ✅
  - [x] สร้าง employee.service.ts สำหรับจัดการ employee operations
  - [x] เพิ่ม getEmployeeList() method พร้อม search/filter/pagination
  - [x] สร้าง types สำหรับ EmployeeListItem, SearchFilters, PaginationParams
  - [x] เพิ่ม utility functions สำหรับ search และ sorting logic

- [x] Task 3: สร้าง Employee List UI Components (AC: 2, 3, 4, 5, 6, 9, 10) ✅
  - [x] สร้าง EmployeeListPage component - หน้าหลัก
  - [x] สร้าง EmployeeTable component - ตารางแสดงข้อมูล
  - [x] สร้าง EmployeeSearchBar component - ช่องค้นหา
  - [x] สร้าง EmployeeFilters component - ตัวกรองต่าง ๆ
  - [x] สร้าง TablePagination component - pagination controls

- [x] Task 4: เพิ่ม Navigation และ Routing (AC: 1) ✅
  - [x] สร้าง /admin/employees page
  - [x] เพิ่ม navigation link "จัดการพนักงาน" ใน admin sidebar
  - [x] เพิ่ม icon และ Thai language labels
  - [x] อัพเดท admin layout เพื่อรองรับหน้าใหม่

- [x] Task 5: Error Handling และ Loading States (AC: 8) ✅
  - [x] เพิ่ม loading skeleton สำหรับตาราง
  - [x] เพิ่ม error boundary สำหรับจัดการ API errors
  - [x] เพิ่ม empty state เมื่อไม่มีพนักงาน
  - [x] เพิ่ม user-friendly error messages เป็นภาษาไทย

- [x] Task 6: Testing และ Validation (ทุก AC) ✅
  - [x] เขียน unit tests สำหรับ employee.service.ts
  - [x] เขียน API tests สำหรับ /api/admin/employees
  - [x] เขียน component tests สำหรับ Employee List components
  - [x] เขียน integration tests สำหรับ search/filter/pagination
  - [x] ทดสอบ responsive design และ accessibility

## Dev Notes

### Integration with Existing System
จาก Stories ก่อนหน้า:
- ✅ Admin authentication และ role protection พร้อมใช้งานจาก Story 1.2
- ✅ users table และ branches table พร้อมใช้งานจาก Story 1.1
- ✅ Admin dashboard layout พร้อมใช้งาน
- ✅ Service layer patterns ถูก establish แล้ว
- ✅ Shadcn UI components พร้อมใช้งาน

### Database Schema Reference
```typescript
// ข้อมูลจาก users table ที่ต้องใช้
interface User {
  id: string
  email: string
  full_name: string
  user_role: 'employee' | 'admin'
  home_branch_id: string
  is_active: boolean  // เพิ่มใหม่ถ้าจำเป็น
  created_at: string
}

// ข้อมูลจาก branches table ที่ต้อง JOIN
interface Branch {
  id: string
  name: string
}

// Response type สำหรับ API
interface EmployeeListResponse {
  data: EmployeeListItem[]
  total: number
  page: number
  limit: number
}
```

### API Design
```typescript
// GET /api/admin/employees
// Query Parameters:
// - search?: string (ค้นหาใน full_name หรือ email)
// - branchId?: string (กรองตามสาขา)
// - role?: 'employee' | 'admin' (กรองตามบทบาท)
// - status?: 'active' | 'inactive' (กรองตามสถานะ)
// - page?: number (หน้าปัจจุบัน, default: 1)
// - limit?: number (จำนวนต่อหน้า, default: 20)
// - sortBy?: 'full_name' | 'email' | 'created_at' (เรียงลำดับตาม)
// - sortOrder?: 'asc' | 'desc' (ทิศทางการเรียง, default: 'asc')
```

### UI/UX Considerations
- ใช้ Shadcn Table component สำหรับแสดงรายการ
- ใช้ Shadcn Input component สำหรับ search bar
- ใช้ Shadcn Select component สำหรับ filters
- ใช้ Shadcn Button component สำหรับ actions
- ใช้ Shadcn Badge component สำหรับ status indicators
- แสดงผลเป็นภาษาไทยทั้งหมด
- ใช้ icons จาก Lucide React (Users, Search, Filter, Plus)

### Performance Considerations
- เพิ่ม database index สำหรับ full_name และ email columns
- ใช้ debounce สำหรับ search functionality (300ms)
- ใช้ React Query หรือ SWR สำหรับ caching API responses
- Lazy loading สำหรับ pagination

### File Locations
ตาม unified project structure:
```
apps/web/src/app/
├── admin/employees/page.tsx
└── api/admin/employees/route.ts

apps/web/src/components/
├── admin/
│   ├── EmployeeListPage.tsx
│   ├── EmployeeTable.tsx
│   ├── EmployeeSearchBar.tsx
│   ├── EmployeeFilters.tsx
│   └── TablePagination.tsx

apps/web/src/lib/services/
└── employee.service.ts
```

## Definition of Done
- [x] API endpoint `/api/admin/employees` ทำงานถูกต้องพร้อม search/filter/pagination ✅
- [x] หน้า `/admin/employees` แสดงผลถูกต้องตาม AC ทุกข้อ ✅
- [x] Navigation link เพิ่มใน admin sidebar แล้ว ✅
- [x] Search, filter, และ pagination ทำงานถูกต้อง ✅
- [x] Responsive design ทำงานดีบน desktop และ tablet ✅
- [x] Unit tests และ integration tests ผ่านทั้งหมด ✅
- [ ] ไม่มี TypeScript errors หรือ console warnings (minor type issues ที่ไม่กระทบการทำงาน)
- [x] Existing admin functions ยังทำงานปกติ (ไม่มี regression) ✅
- [x] Loading states และ error handling ทำงานถูกต้อง ✅

## Implementation Files
### API Routes
- `apps/web/src/app/api/admin/employees/route.ts` - GET endpoint with search/filter/pagination

### Service Layer
- `apps/web/src/lib/services/employee.service.ts` - Employee operations service with comprehensive filtering and utilities

### UI Components
- `apps/web/src/app/admin/employees/page.tsx` - Main employee management page
- `apps/web/src/components/admin/EmployeeListPage.tsx` - Main component with state management
- `apps/web/src/components/admin/EmployeeTable.tsx` - Data table with sorting and responsive design
- `apps/web/src/components/admin/EmployeeSearchBar.tsx` - Debounced search input
- `apps/web/src/components/admin/EmployeeFilters.tsx` - Multi-filter component with active filter display
- `apps/web/src/components/admin/TablePagination.tsx` - Full pagination with page size controls

### Navigation
- `apps/web/src/components/admin/AdminSidebar.tsx` - Updated with employee management link

### Testing
- `apps/web/src/__tests__/api/admin/employees.test.ts` - API endpoint tests
- `apps/web/src/__tests__/services/employee.service.test.ts` - Service layer unit tests
- `apps/web/src/__tests__/components/admin/EmployeeTable.test.tsx` - Table component tests
- `apps/web/src/__tests__/components/admin/EmployeeSearchBar.test.tsx` - Search component tests
- `apps/web/src/__tests__/components/admin/EmployeeFilters.test.tsx` - Filter component tests
- `apps/web/src/__tests__/components/admin/TablePagination.test.tsx` - Pagination tests
- `apps/web/src/__tests__/integration/employee-management.test.tsx` - Integration tests

### Database Schema Fixes
- Updated employee.service.ts to use correct database field names (role vs user_role, branch_id vs home_branch_id)
- Fixed field mappings to match actual database schema from migration files

## Risk Assessment
**Low Risk** - ฟีเจอร์นี้เป็น read-only และไม่กระทบข้อมูลที่มีอยู่
- ไม่แก้ database schema หลัก
- ไม่กระทบ authentication และ time entry systems
- ใช้ existing patterns และ technologies
- การ rollback ง่าย (ลบ route และ navigation link)

**Compatibility Verification:**
- [ ] ไม่มี breaking changes ต่อ existing APIs
- [ ] Database queries เป็น read-only เท่านั้น
- [ ] UI changes ตาม existing admin design patterns
- [ ] Performance impact ขั้นต่ำ (pagination + indexing)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Initial story creation สำหรับ Employee List & Search Management - ส่วนแรกของ Epic 4: Employee Management System | Sarah (PO) |