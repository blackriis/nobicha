# Story 1.4: Employee Time Entry System (Check-in/Check-out UI)

## Status
Done

## Story
**As a** Employee ของระบบบริหารจัดการพนักงาน,  
**I want** ระบบ check-in และ check-out พื้นฐานที่เชื่อมโยงกับ GPS และ branch selection,  
**so that** ฉันสามารถบันทึกเวลาเข้าทำงานและออกจากงานได้อย่างแม่นยำ โดยไม่ต้องถ่าย selfie ในขั้นตอนนี้ (จะเพิ่ม selfie ใน Story 1.5)

## Acceptance Criteria
1. Employee สามารถเลือกสาขาที่ต้องการ check-in ได้ (จาก available branches ที่อยู่ในรัศมี 100 เมตร)
2. ระบบตรวจสอบ GPS location และแสดงเฉพาะสาขาที่สามารถ check-in ได้
3. Employee สามารถกด "Check-In" เพื่อบันทึกเวลาเริ่มงานได้
4. Employee สามารถกด "Check-Out" เพื่อบันทึกเวลาเลิกงานได้ (เมื่อมี active check-in)
5. ระบบแสดงสถานะ check-in/check-out ปัจจุบันของ employee อย่างชัดเจน
6. ระบบป้องกันการ check-in ซ้ำถ้ายังไม่ได้ check-out จากครั้งก่อน
7. ระบบบันทึกข้อมูลลงตาราง time_entries (ยังไม่รวม selfie URL - รอ Story 1.5)
8. มีการแสดง error handling เมื่อไม่สามารถเข้าถึง GPS ได้หรือไม่มีสาขาในรัศมี

## Tasks / Subtasks
- [ ] Task 1: สร้าง Time Entry API Endpoints (AC: 3, 4, 6, 7)
  - [ ] สร้าง POST /api/employee/time-entries/check-in - บันทึกการ check-in
  - [ ] สร้าง POST /api/employee/time-entries/check-out - บันทึกการ check-out  
  - [ ] สร้าง GET /api/employee/time-entries/status - ดึงสถานะ check-in ปัจจุบัน
  - [ ] เพิ่ม validation สำหรับป้องกัน double check-in และ GPS location
- [ ] Task 2: สร้าง Time Entry Service Layer (AC: 1, 2, 7)
  - [ ] สร้าง time-entry.service.ts สำหรับจัดการ CRUD operations
  - [ ] integrate กับ location.service.ts เพื่อตรวจสอบ GPS
  - [ ] integrate กับ branch.service.ts เพื่อ validate branch selection
- [ ] Task 3: สร้าง Employee Dashboard UI Components (AC: 1, 2, 3, 4, 5)
  - [ ] สร้าง CheckInOutCard component - แสดงสถานะและปุ่มหลัก
  - [ ] สร้าง BranchSelector component - เลือกสาขาสำหรับ check-in
  - [ ] สร้าง TimeEntryStatus component - แสดงสถานะปัจจุบัน
  - [ ] สร้าง LocationErrorHandler component - จัดการ GPS errors (AC: 8)
- [ ] Task 4: สร้าง Employee Dashboard Page (AC: ทุก AC)
  - [ ] อัพเดท /dashboard page ให้รวม time entry functionality
  - [ ] เชื่อมต่อ components กับ service layer
  - [ ] เพิ่ม real-time status updates
- [ ] Task 5: Unit Testing (ทุก AC)
  - [ ] เขียน unit tests สำหรับ Time Entry API endpoints
  - [ ] เขียน unit tests สำหรับ time-entry.service.ts
  - [ ] เขียน component tests สำหรับ Time Entry UI components
  - [ ] เขียน integration tests สำหรับ check-in/check-out workflow

## Dev Notes

### Previous Story Insights
จาก Story 1.3 (Branch Management and GPS Configuration):
- ✅ GPS location services พร้อมใช้งานที่ `apps/web/src/lib/services/location.service.ts`
- ✅ Branch availability API พร้อมที่ `/api/employee/available-branches` 
- ✅ GPS utilities กับ Haversine formula ที่ `apps/web/src/lib/utils/gps.utils.ts`
- ✅ LocationPermissionHandler component พร้อมที่ `apps/web/src/components/location/`
- ✅ Authentication middleware และ role protection พร้อมใช้งาน
- ✅ Service layer pattern ตั้งค่าแล้วใน `apps/web/src/lib/services/`

จาก Story 1.2 (User Authentication & Role-Based Access Control):
- ✅ Supabase client configuration พร้อมที่ `apps/web/src/lib/supabase.ts`
- ✅ Dashboard structure พร้อมที่ `apps/web/src/app/dashboard/page.tsx`
- ✅ Employee role protection middleware พร้อมใช้งาน

### Data Models
[Source: architecture/data-models-database-schema.md]
- **time_entries table**: 
  ```sql
  CREATE TABLE time_entries ( 
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(), 
    employee_id UUID NOT NULL REFERENCES users(id), 
    branch_id UUID NOT NULL REFERENCES branches(id), 
    check_in_time TIMESTAMPTZ NOT NULL, 
    check_out_time TIMESTAMPTZ, 
    check_in_selfie_url TEXT NOT NULL, 
    check_out_selfie_url TEXT, 
    created_at TIMESTAMPTZ DEFAULT now() 
  )
  ```
  **IMPORTANT**: ใน Story นี้จะใส่ placeholder สำหรับ `check_in_selfie_url` และ `check_out_selfie_url` เพราะยังไม่มี selfie capture (รอ Story 1.5)

- **users table**: มี `home_branch_id`, `hourly_rate`, `daily_rate` สำหรับคำนวณเงินเดือน
- **branches table**: มี `latitude`, `longitude` สำหรับตรวจสอบ GPS location

### API Specifications
[Source: architecture/api-specification.md]
- ใช้ Next.js API Routes ตามมาตรฐาน OpenAPI 3.0
- Employee endpoints ที่ `/api/employee/` สำหรับ employee functions
- Primary endpoints สำหรับ story นี้:
  - `POST /api/employee/time-entries/check-in` - บันทึก check-in
  - `POST /api/employee/time-entries/check-out` - บันทึก check-out
  - `GET /api/employee/time-entries/status` - ดู check-in status ปัจจุบัน

### Component Specifications  
[Source: architecture/components-core-workflows.md]
- ใช้ Feature-based component organization
- Components ต้องรองรับ authentication workflow ที่มีอยู่แล้ว
- ต้องรองรับ Sequence Diagram patterns สำหรับ check-in workflow

### File Locations
[Source: architecture/unified-project-structure.md]
ตาม unified project structure ไฟล์ควรอยู่ที่:
```
apps/web/src/app/
├── api/employee/time-entries/
│   ├── check-in/route.ts
│   ├── check-out/route.ts
│   └── status/route.ts
└── dashboard/page.tsx (อัพเดท)

apps/web/src/components/
├── employee/
│   ├── CheckInOutCard.tsx
│   ├── BranchSelector.tsx
│   ├── TimeEntryStatus.tsx
│   └── LocationErrorHandler.tsx

apps/web/src/lib/services/
└── time-entry.service.ts
```

### Technical Constraints
[Source: architecture/tech-stack.md]
- **Frontend**: Next.js 15.0 with TypeScript 5.4
- **Database**: Supabase PostgreSQL with existing schema
- **UI Library**: Shadcn UI (latest) for consistent styling
- **State Management**: Zustand 4.5 สำหรับ complex state (ถ้าจำเป็น)

[Source: architecture/coding-standards.md]
- **Database Types**: ต้อง import จาก `packages/database` เท่านั้น
- **Environment Variables**: ห้ามใช้ `process.env` โดยตรง - ต้องใช้ผ่าน `packages/config`
- **API Calls**: ต้องผ่าน Service Layer ห้าม fetch โดยตรงจาก Component

### Time Entry Implementation Notes
- เนื่องจากยังไม่มี selfie capture ใน Story นี้ จะใช้ placeholder values สำหรับ `check_in_selfie_url` และ `check_out_selfie_url`
- ต้องใช้ GPS validation จาก Story 1.3 เพื่อตรวจสอบว่า employee อยู่ในรัศมี 100 เมตรจากสาขา
- ต้องป้องกัน double check-in โดยตรวจสอบว่ามี active time_entry ที่ยังไม่ได้ check-out
- Status checking ต้องใช้ real-time data จาก database
- Error handling สำหรับกรณี GPS ไม่ทำงานหรือไม่มีสาขาในรัศมี

### Testing
[Source: architecture/tech-stack.md]
- **Unit & Integration Testing**: Vitest + React Testing Library
- **E2E Testing**: Playwright 1.4
- Test files ควรอยู่ที่ `apps/web/src/__tests__/`
- API endpoints ต้องมี integration tests
- Time entry functions ต้องมี unit tests with mocked GPS และ database
- Components ต้องมี tests สำหรับ error states และ loading states
- E2E tests สำหรับ complete check-in/check-out workflow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Initial story creation สำหรับ Employee Time Entry System โดยไม่รวม selfie (รอ Story 1.5) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
(รอการกรอกจาก Dev Agent)

### Debug Log References
(รอการกรอกจาก Dev Agent)

### Completion Notes List
(รอการกรอกจาก Dev Agent)

### File List
(รอการกรอกจาก Dev Agent)

## QA Results

(รอการกรอกจาก QA Agent)