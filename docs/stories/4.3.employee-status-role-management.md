# Story 4.3: Employee Status & Role Management (จัดการสถานะและบทบาทพนักงาน)

## Status
Draft

## Story
**As a** Admin ของระบบบริหารจัดการพนักงาน,  
**I want** ระบบจัดการสถานะพนักงาน (เปิด/ปิดใช้งาน) และบทบาท (พนักงาน/แอดมิน) พร้อมยืนยันความปลอดภัย,  
**so that** ฉันสามารถควบคุมการเข้าถึงระบบและจัดการทีมได้อย่างมีประสิทธิภาพและปลอดภัย

## Acceptance Criteria
1. Admin สามารถเปลี่ยนสถานะพนักงานจาก "เปิดใช้งาน" เป็น "ปิดใช้งาน" และในทางกลับกัน
2. เมื่อพนักงานถูก "ปิดใช้งาน" จะไม่สามารถ login เข้าระบบได้
3. Admin สามารถเปลี่ยนบทบาทพนักงานจาก "employee" เป็น "admin" และในทางกลับกัน
4. มี confirmation dialog ก่อนเปลี่ยนแปลงสถานะหรือบทบาท
5. แสดง warning message เมื่อจะเปลี่ยนพนักงานเป็น admin
6. Admin ไม่สามารถปิดใช้งานหรือลดบทบาทตัวเองได้ (self-protection)
7. ต้องมี admin อย่างน้อย 1 คนในระบบเสมอ (ไม่ให้ลดบทบาท admin คนสุดท้าย)
8. แสดงประวัติการเปลี่ยนแปลง (audit log) พร้อมวันเวลาและผู้ดำเนินการ
9. มี bulk actions สำหรับเปลี่ยนสถานะหลายคนพร้อมกัน
10. แสดง success/error messages เป็นภาษาไทย

## Tasks / Subtasks
- [ ] Task 1: สร้าง Status & Role Management API Endpoints (AC: 1, 2, 3, 6, 7)
  - [ ] สร้าง PATCH /api/admin/employees/[id]/status - เปลี่ยนสถานะ
  - [ ] สร้าง PATCH /api/admin/employees/[id]/role - เปลี่ยนบทบาท
  - [ ] สร้าง POST /api/admin/employees/bulk-status - bulk status change
  - [ ] เพิ่ม validation สำหรับ self-protection และ last admin protection
  - [ ] เพิ่ม Supabase Auth integration สำหรับ disable user

- [ ] Task 2: สร้าง Audit Log System (AC: 8)
  - [ ] สร้าง audit_logs table (ถ้าจำเป็น)
  - [ ] สร้าง POST /api/admin/audit-logs - บันทึกการเปลี่ยนแปลง
  - [ ] สร้าง GET /api/admin/employees/[id]/audit-logs - ดูประวัติ
  - [ ] เพิ่ม audit logging ใน status/role change operations

- [ ] Task 3: ขยาย Employee Service Layer (AC: 1, 3, 6, 7, 8)
  - [ ] เพิ่ม changeEmployeeStatus() method
  - [ ] เพิ่ม changeEmployeeRole() method
  - [ ] เพิ่ม bulkChangeStatus() method
  - [ ] เพิ่ม getAuditLogs() method
  - [ ] เพิ่ม validation utilities สำหรับ business rules

- [ ] Task 4: สร้าง Status & Role UI Components (AC: 1, 3, 4, 5, 9, 10)
  - [ ] สร้าง StatusToggleButton component - ปุ่มเปลี่ยนสถานะ
  - [ ] สร้าง RoleChangeButton component - ปุ่มเปลี่ยนบทบาท
  - [ ] สร้าง ConfirmationDialog component - dialog ยืนยัน
  - [ ] สร้าง BulkActionsBar component - bulk operations
  - [ ] สร้าง AuditLogModal component - แสดงประวัติ

- [ ] Task 5: อัพเดท Employee List Integration (AC: 1, 3, 8, 9)
  - [ ] อัพเดท EmployeeTable component เพิ่ม status/role actions
  - [ ] เพิ่ม checkbox selection สำหรับ bulk actions
  - [ ] เพิ่ม action buttons สำหรับแต่ละรายการ
  - [ ] เพิ่ม audit log link/icon สำหรับแต่ละรายการ
  - [ ] อัพเดท status indicators และ role badges

- [ ] Task 6: Business Logic Validation (AC: 6, 7)
  - [ ] เพิ่ม self-protection validation
  - [ ] เพิ่ม last admin protection validation
  - [ ] เพิ่ม role change impact analysis
  - [ ] เพิ่ม confirmation messages ตามประเภทการเปลี่ยนแปลง

- [ ] Task 7: Testing และ Security (ทุก AC)
  - [ ] เขียน unit tests สำหรับ business logic validation
  - [ ] เขียน API tests สำหรับ status/role change endpoints
  - [ ] เขียน component tests สำหรับ UI interactions
  - [ ] เขียน integration tests สำหรับ audit logging
  - [ ] ทดสอบ security: authorization, self-protection, admin protection

## Dev Notes

### Integration with Existing System
จาก Stories ก่อนหน้า:
- ✅ Story 4.1: Employee List Page จะเป็น main interface
- ✅ Story 4.2: Employee Profile data structure พร้อมใช้งาน
- ✅ Supabase Auth system สำหรับ disable user accounts
- ✅ Admin authentication และ permissions
- ✅ Service layer patterns และ error handling

### Database Schema Extensions
```sql
-- เพิ่ม audit_logs table สำหรับบันทึกการเปลี่ยนแปลง
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  admin_id UUID NOT NULL REFERENCES users(id),
  action_type TEXT NOT NULL, -- 'status_change', 'role_change'
  old_value TEXT,
  new_value TEXT,
  reason TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- เพิ่ม index สำหรับ performance
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_admin_id ON audit_logs(admin_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
```

### Business Logic Rules
```typescript
// Self-protection rules
const canModifySelf = (adminId: string, targetUserId: string): boolean => {
  return adminId !== targetUserId;
};

// Last admin protection
const canRemoveAdminRole = async (userId: string): Promise<boolean> => {
  const adminCount = await getActiveAdminCount();
  const isTargetAdmin = await isUserAdmin(userId);
  return !(isTargetAdmin && adminCount <= 1);
};

// Status change validation
const canDeactivateUser = (adminId: string, targetUserId: string): boolean => {
  // Admin cannot deactivate themselves
  return adminId !== targetUserId;
};
```

### API Design
```typescript
// PATCH /api/admin/employees/[id]/status
// Body: { is_active: boolean, reason?: string }
// Response: { success: boolean, message: string, audit_log: AuditLog }

// PATCH /api/admin/employees/[id]/role
// Body: { user_role: 'employee' | 'admin', reason?: string }
// Response: { success: boolean, message: string, audit_log: AuditLog }

// POST /api/admin/employees/bulk-status
// Body: { user_ids: string[], is_active: boolean, reason?: string }
// Response: { success: boolean, processed: number, failed: number, messages: string[] }

// GET /api/admin/employees/[id]/audit-logs
// Query: page?, limit?
// Response: { logs: AuditLog[], total: number }
```

### UI/UX Design Specifications
- **Status Toggle**: Switch component แสดงสถานะ "เปิดใช้งาน/ปิดใช้งาน"
- **Role Badge**: Badge component แสดงบทบาท "พนักงาน/ผู้ดูแลระบบ"
- **Action Buttons**: Dropdown menu สำหรับ actions
- **Bulk Selection**: Checkbox สำหรับเลือกหลายรายการ
- **Confirmation Dialogs**: แสดงรายละเอียดการเปลี่ยนแปลงและผลกระทบ
- **Audit Log**: Modal หรือ separate page แสดงประวัติ
- **Warning Messages**: สำหรับการเปลี่ยนแปลงที่มีความเสี่ยง

### Supabase Auth Integration
```typescript
// สำหรับ disable user account
const disableUserAuth = async (userId: string) => {
  await supabase.auth.admin.updateUserById(userId, {
    user_metadata: { is_active: false }
  });
  // หรือใช้ RLS policies ใน database
};

// สำหรับ enable user account
const enableUserAuth = async (userId: string) => {
  await supabase.auth.admin.updateUserById(userId, {
    user_metadata: { is_active: true }
  });
};
```

### Security Considerations
- ตรวจสอบ admin permissions ก่อนทุก operation
- Log ทุกการเปลี่ยนแปลงพร้อม admin identity
- Validate business rules ทั้ง client และ server
- ป้องกัน concurrent modifications
- Rate limiting สำหรับ bulk operations
- Encrypt sensitive data ใน audit logs

### File Locations
```
apps/web/src/app/
└── api/admin/employees/
    ├── [id]/
    │   ├── status/route.ts
    │   ├── role/route.ts
    │   └── audit-logs/route.ts
    └── bulk-status/route.ts

apps/web/src/components/
├── admin/
│   ├── StatusToggleButton.tsx
│   ├── RoleChangeButton.tsx
│   ├── ConfirmationDialog.tsx
│   ├── BulkActionsBar.tsx
│   └── AuditLogModal.tsx

database/migrations/
└── 007_audit_logs_table.sql

apps/web/src/lib/services/
└── employee.service.ts (ขยายต่อ)
```

## Definition of Done
- [ ] API endpoints สำหรับ status/role management ทำงานถูกต้อง
- [ ] Business logic validation ทำงาน (self-protection, last admin protection)
- [ ] UI components สำหรับ status/role management ใน Employee List
- [ ] Bulk operations ทำงานถูกต้อง
- [ ] Audit logging system บันทึกการเปลี่ยนแปลงครบถ้วน
- [ ] Confirmation dialogs และ warning messages เป็นภาษาไทย
- [ ] Supabase Auth integration สำหรับ disable accounts ทำงาน
- [ ] Unit tests และ integration tests ผ่านทั้งหมด
- [ ] Security validation ผ่าน (authorization, business rules)
- [ ] ไม่มี TypeScript errors หรือ console warnings
- [ ] Existing systems ยังทำงานปกติ (ไม่มี regression)

## Risk Assessment
**High Risk** - มีการจัดการ permissions และ authentication
- **Risk**: การเปลี่ยน role อาจสร้างช่องโหว่ security
- **Mitigation**: Validate business rules เข้มงวด, comprehensive testing
- **Risk**: Admin อาจทำตัวเองไม่สามารถเข้าถึงระบบได้
- **Mitigation**: Self-protection และ last admin protection
- **Risk**: Bulk operations อาจกระทบผู้ใช้จำนวนมาก
- **Mitigation**: ใช้ transaction, confirmation dialog, rollback mechanism
- **Rollback**: Revert status/role changes, restore from audit logs

**Compatibility Verification:**
- [ ] Authentication system ยังทำงานปกติหลัง role changes
- [ ] Disabled users ไม่สามารถ login ได้
- [ ] Role-based access control ยังทำงานถูกต้อง
- [ ] Time entry system ยังใช้งานได้กับ active users

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Initial story creation สำหรับ Employee Status & Role Management - ส่วนสุดท้ายของ Epic 4: Employee Management System | Sarah (PO) |