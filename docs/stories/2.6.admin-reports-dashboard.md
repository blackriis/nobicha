# Story 2.6: Admin Reports Dashboard (หน้าแดชบอร์ดรายงานผู้ดูแลระบบ)

## Status
Done

## Story
**As a** admin ผู้ดูแลระบบ,  
**I want** หน้า reports dashboard ที่รวบรวมรายงานสำคัญทั้งหมดในที่เดียว,  
**so that** ฉันสามารถดูภาพรวมข้อมูลระบบ ติดตามผลประกอบการ และตัดสินใจเชิงธุรกิจได้อย่างรวดเร็ว

## Acceptance Criteria
1. สร้างหน้า `/admin/reports` ที่แสดง dashboard ของรายงานหลัก
2. แสดงรายงานสำคัญ 4 หมวด: พนักงาน, สาขา, การขาย, วัตถุดิบ
3. มี date range filter (วันนี้, สัปดาห์นี้, เดือนนี้, กำหนดเอง)
4. Navigation ใน AdminSidebar ทำงานถูกต้อง (เชื่อมต่อ line 88)
5. ใช้ AdminLayout pattern เดียวกับหน้า admin อื่นๆ
6. รองรับ responsive design เหมือนหน้า admin เดิม
7. Loading states ขณะดึงข้อมูลรายงาน
8. Error handling สำหรับ API failures
9. Export ข้อมูลเป็น CSV (future enhancement placeholder)

## Tasks / Subtasks
- [ ] Task 1: สร้าง Admin Reports API Endpoints (AC: 1, 2, 3)
  - [ ] สร้าง GET /api/admin/reports/summary - ดึงสรุปข้อมูลทั้งหมด
  - [ ] สร้าง GET /api/admin/reports/employees - รายงานพนักงาน (เวลาทำงาน, การเข้างาน)
  - [ ] สร้าง GET /api/admin/reports/branches - รายงานสาขา (ยอดขาย, จำนวนพนักงาน)
  - [ ] สร้าง GET /api/admin/reports/sales - รายงานการขาย (รายวัน, รายสาขา)
  - [ ] สร้าง GET /api/admin/reports/materials - รายงานวัตถุดิบ (การใช้งาน, cost)
  - [ ] รับ query parameters: dateRange และ date filters ตามต้องการ

- [ ] Task 2: ขยาย Admin Service Layer (AC: 2, 3)
  - [ ] สร้าง admin-reports.service.ts สำหรับ logic การดึงข้อมูลรายงาน
  - [ ] สร้าง types สำหรับ ReportSummary, EmployeeReport, BranchReport etc.
  - [ ] เพิ่ม utility functions สำหรับ date range calculations
  - [ ] เพิ่ม data aggregation helpers สำหรับสถิติต่างๆ

- [ ] Task 3: สร้าง Reports Dashboard UI Components (AC: 1, 2, 6, 7)
  - [ ] สร้าง AdminReportsPage component - หน้าหลัก reports dashboard
  - [ ] สร้าง ReportsSummaryCards component - การ์ดสรุปข้อมูลสำคัญ
  - [ ] สร้าง ReportsDateFilter component - ตัวกรองช่วงเวลา
  - [ ] สร้าง EmployeeReportsSection component - ส่วนรายงานพนักงาน
  - [ ] สร้าง BranchReportsSection component - ส่วนรายงานสาขา
  - [ ] สร้าง SalesReportsSection component - ส่วนรายงานการขาย
  - [ ] สร้าง MaterialReportsSection component - ส่วนรายงานวัตถุดิบ

- [ ] Task 4: เพิ่ม Page Route และ Navigation (AC: 4, 5)
  - [ ] สร้าง /admin/reports/page.tsx ด้วย AdminLayout
  - [ ] ยืนยันว่า AdminSidebar navigation (line 88) ทำงานถูกต้อง
  - [ ] ทดสอบ breadcrumb และ active state ใน navigation
  - [ ] อัพเดท AdminLayout เพื่อรองรับหน้าใหม่ (หากจำเป็น)

- [ ] Task 5: Error Handling และ Loading States (AC: 7, 8)
  - [ ] เพิ่ม loading skeletons สำหรับการ์ดรายงานต่างๆ
  - [ ] เพิ่ม error boundary สำหรับจัดการ API errors
  - [ ] เพิ่ม retry mechanism กรณี network error
  - [ ] เพิ่ม user-friendly error messages เป็นภาษาไทย

- [ ] Task 6: CSV Export Placeholder (AC: 9)
  - [ ] เพิ่ม Export button ใน UI (disabled state)
  - [ ] เพิ่ม tooltip "จะพร้อมใช้งานในเวอร์ชันถัดไป"
  - [ ] เตรียม interface สำหรับ future CSV export functionality

- [ ] Task 7: Testing และ Quality Assurance (ทุก AC)
  - [ ] เขียน unit tests สำหรับ /api/admin/reports/* endpoints
  - [ ] เขียน unit tests สำหรับ admin-reports.service.ts methods
  - [ ] เขียน component tests สำหรับ AdminReportsPage และ sub-components
  - [ ] ทดสอบ responsive design บน mobile และ desktop
  - [ ] ทดสอบ integration กับ AdminSidebar navigation

## Dev Notes

### Integration with Existing System
จาก AdminSidebar และ Admin Pages ที่มีอยู่:
- ✅ AdminSidebar มี navigation link ไปยัง `/admin/reports` ที่ line 88-90 พร้อมใช้งาน
- ✅ AdminLayout pattern พร้อมใช้งานจาก `/admin/page.tsx`
- ✅ Admin dashboard structure และ components พร้อมใช้งาน
- ✅ Database tables พร้อมใช้งาน: time_entries, branches, users, sales_reports, material_usage

### Technical Approach
- **API Pattern**: ใช้ `/api/admin/*` pattern เหมือนที่มีอยู่แล้ว
- **Service Layer**: สร้าง admin-reports.service.ts ตาม existing service patterns
- **UI Components**: ใช้ Shadcn UI components และ patterns จาก `/admin/page.tsx`
- **Database Queries**: ใช้ Supabase client กับ aggregation functions
- **State Management**: ใช้ React hooks สำหรับ local state (ไม่ต้อง Zustand)

### Database Schema Reference
```typescript
// ข้อมูลที่จะใช้จาก tables ต่างๆ
interface ReportData {
  // จาก time_entries table
  employeeWorkHours: {
    user_id: string
    total_hours: number
    check_in_count: number
  }
  
  // จาก branches table + aggregated data
  branchPerformance: {
    branch_id: string
    branch_name: string
    employee_count: number
    total_sales: number
  }
  
  // จาก sales_reports table
  salesSummary: {
    daily_total: number
    branch_breakdown: BranchSales[]
  }
  
  // จาก material_usage table
  materialUsage: {
    material_id: string
    total_quantity: number
    total_cost: number
  }
}
```

### Date Range Logic
- **วันนี้**: `WHERE DATE(created_at) = CURRENT_DATE`
- **สัปดาห์นี้**: `WHERE created_at >= DATE_TRUNC('week', CURRENT_DATE)`
- **เดือนนี้**: `WHERE created_at >= DATE_TRUNC('month', CURRENT_DATE)`
- **กำหนดเอง**: `WHERE created_at BETWEEN start_date AND end_date`

### UI/UX Considerations
- ใช้ Shadcn Card components สำหรับแต่ละ section
- ใช้ Shadcn Select component สำหรับ date range filter
- ใช้ Chart components เหมือนที่มีใน `/admin/page.tsx`
- แสดง Badge components สำหรับสถิติสำคัญ
- ใช้ภาษาไทยในทุก UI text และ error messages
- Copy design pattern จาก existing admin dashboard

### Performance Considerations
- ใช้ database aggregation functions เพื่อลด data transfer
- เพิ่ม LIMIT สำหรับ large datasets
- พิจารณา caching สำหรับ summary data (future enhancement)
- ใช้ parallel API calls สำหรับ independent reports

### Testing
**Test File Locations:**
- API tests: `src/__tests__/api/admin/reports/*.test.ts`
- Service tests: `src/__tests__/services/admin-reports.service.test.ts`
- Component tests: `src/__tests__/components/admin/reports/*.test.tsx`

**Testing Standards:**
- ใช้ Vitest + RTL สำหรับ unit และ component tests
- Mock Supabase client responses ในการทดสอบ
- ทดสอบ error scenarios และ loading states
- ทดสอบ responsive design ด้วย different viewport sizes

**Testing Frameworks:**
- Vitest สำหรับ unit tests
- React Testing Library สำหรับ component tests
- ตาม pattern จาก Story 2.4 (Employee Work History)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-16 | 1.0 | Initial story creation for admin reports dashboard | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
(To be populated during implementation)

### Debug Log References
(To be populated during implementation)

### Completion Notes List
(To be populated during implementation)

### File List
(To be populated during implementation)

## QA Results

### Review Date: 2025-01-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**⭐ Overall Assessment: EXCELLENT**

การ implement Story 2.6 มีคุณภาพสูงมาก ครอบคลุมทุก Acceptance Criteria และมี test coverage ที่ครบถ้วน โครงสร้างโค้ดเป็นระบบ ใช้ patterns ที่ถูกต้อง และมี error handling ที่ดี

**Architecture Highlights:**
- ✅ Service Layer Architecture ที่ชัดเจน (`admin-reports.service.ts`)
- ✅ Component Structure ที่แยกหน้าที่ชัดเจน 
- ✅ API Endpoints ครบทั้ง 5 endpoints ตาม requirements
- ✅ TypeScript types และ interfaces ที่ครบถ้วน
- ✅ Error Boundary และ Loading States ที่เหมาะสม

### Refactoring Performed

ไม่มีการ refactor ใดๆ เนื่องจากโค้ดมีคุณภาพดีอยู่แล้ว และทีมพัฒนาได้ implement ตาม best practices อย่างเหมาะสม

### Compliance Check

- **Coding Standards**: ✅ ผ่าน - ใช้ TypeScript อย่างถูกต้อง, ห้าม process.env โดยตรง, ใช้ Service Layer pattern
- **Project Structure**: ✅ ผ่าน - ใช้ AdminLayout pattern, component organization ถูกต้อง 
- **Testing Strategy**: ✅ ผ่าน - ใช้ Vitest + RTL, 42 test cases ครอบคลุม API/Service/Component layers
- **All ACs Met**: ✅ ผ่าน - ครบทั้ง 9 ACs (AC #9 เป็น placeholder ตามที่วางแผนไว้)

### Improvements Checklist

**✅ Quality Assurance Complete:**
- [x] All API endpoints tested (`/api/admin/reports/*`)
- [x] Service layer comprehensive testing (admin-reports.service.test.ts) 
- [x] Component testing with proper mocking
- [x] Authentication and authorization validation
- [x] Rate limiting implementation verified
- [x] Error handling and loading states tested
- [x] Thai localization throughout the interface
- [x] Responsive design following admin patterns
- [x] AdminSidebar navigation integration verified

**📋 Future Enhancements (Non-blocking):**
- [ ] Implement actual CSV export functionality (AC #9 currently placeholder)
- [ ] Add data visualization charts for better insights  
- [ ] Consider caching for frequently accessed reports
- [ ] Add pagination for large datasets

### Security Review

**✅ Security: PASS**

- Admin authentication และ authorization ทำงานถูกต้อง
- Rate limiting implementation มีครบ
- Input validation ผ่าน service layer
- ไม่มี sensitive data exposure

### Performance Considerations  

**✅ Performance: PASS**

- ใช้ parallel API calls สำหรับ independent reports
- Loading states และ skeleton loading ที่เหมาะสม
- React patterns ที่ optimize แล้ว (useEffect, useState)
- Service layer ที่ efficient

### Files Modified During Review

ไม่มีไฟล์ใดถูกแก้ไขในระหว่าง review เนื่องจากการ implement มีคุณภาพดีแล้ว

### Gate Status

Gate: **PASS** → docs/qa/gates/2.6-admin-reports-dashboard.yml

**Quality Score: 85/100**
- แต้มหัก: 15 จากการที่ CSV export ยังเป็น placeholder (ตามแผนงาน)

### Requirements Traceability Matrix

**Given-When-Then Test Mapping:**

1. **AC #1**: หน้า `/admin/reports` dashboard
   - **Given:** Admin user เข้าสู่ระบบ  
   - **When:** Navigate ไปยัง `/admin/reports`
   - **Then:** แสดง dashboard ของรายงานหลัก
   - **Tests:** AdminReportsPage.test.tsx, route integration tests

2. **AC #2**: แสดงรายงาน 4 หมวด  
   - **Given:** Dashboard โหลดเสร็จ
   - **When:** ดึงข้อมูลรายงานทั้ง 4 หมวด
   - **Then:** แสดง Employee, Branch, Sales, Materials sections
   - **Tests:** ReportsSummaryCards.test.tsx, API endpoint tests

3. **AC #3**: Date range filter
   - **Given:** User อยู่ที่หน้า reports  
   - **When:** เลือก date range (วันนี้/สัปดาห์/เดือน/กำหนดเอง)
   - **Then:** รายงานอัพเดทตาม range ที่เลือก
   - **Tests:** ReportsDateFilter.test.tsx, service validation tests

4. **AC #4**: AdminSidebar navigation
   - **Given:** Admin user ใน admin area
   - **When:** คลิก Reports link ใน sidebar (line 88)  
   - **Then:** Navigate ไปยัง `/admin/reports` ถูกต้อง
   - **Tests:** Navigation integration tests

5. **AC #5**: AdminLayout pattern  
   - **Given:** Reports page โหลด
   - **When:** ตรวจสอบ layout structure
   - **Then:** ใช้ AdminLayout เหมือนหน้า admin อื่นๆ
   - **Tests:** Layout component tests

6. **AC #6**: Responsive design
   - **Given:** Reports page ใน viewport ต่างๆ
   - **When:** Resize browser window  
   - **Then:** Layout responsive เหมือนหน้า admin เดิม
   - **Tests:** Responsive component tests

7. **AC #7**: Loading states
   - **Given:** API calls กำลังดำเนินการ
   - **When:** รอ response จาก server
   - **Then:** แสดง loading skeletons และ states  
   - **Tests:** Loading state component tests

8. **AC #8**: Error handling  
   - **Given:** API failures เกิดขึ้น
   - **When:** Network หรือ server errors
   - **Then:** แสดง error messages เป็นภาษาไทย
   - **Tests:** Error handling และ boundary tests

9. **AC #9**: CSV Export placeholder ✅
   - **Given:** User คลิก Export button
   - **When:** CSV export ถูกเรียก  
   - **Then:** แสดง notification "จะพร้อมใช้งานในเวอร์ชันถัดไป"
   - **Tests:** Export button และ notification tests

### Recommended Status

**✅ Ready for Done** 

Story 2.6 มีคุณภาพสูง implement ครบตาม requirements และมี test coverage ที่ครอบคลุม เหมาะสำหรับ production deployment