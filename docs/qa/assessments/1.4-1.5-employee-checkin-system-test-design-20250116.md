# Test Design: Employee Check-in System (Stories 1.4 & 1.5)

Date: 2025-01-16
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 42
- Unit tests: 18 (43%)
- Integration tests: 16 (38%)
- E2E tests: 8 (19%)
- Priority distribution: P0: 22, P1: 14, P2: 4, P3: 2

## Test Scenarios by Acceptance Criteria

### Story 1.4: Basic Time Entry System

#### AC1: Employee สามารถเลือกสาขาที่ต้องการ check-in ได้ (จาก available branches ที่อยู่ในรัศมี 100 เมตร)

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.4-UNIT-001  | Unit        | P0       | Validate branch distance calculation    | Critical GPS calculation logic    |
| 1.4-UNIT-002  | Unit        | P1       | Test branch filtering by radius         | Core business logic               |
| 1.4-INT-003   | Integration | P0       | API returns available branches          | Database integration critical     |
| 1.4-E2E-001   | E2E         | P1       | Employee selects branch from UI         | Critical user journey             |

#### AC2: ระบบตรวจสอบ GPS location และแสดงเฉพาะสาขาที่สามารถ check-in ได้

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.4-UNIT-003  | Unit        | P0       | GPS coordinate validation               | Critical location logic           |
| 1.4-UNIT-004  | Unit        | P1       | Haversine formula accuracy test         | Algorithm correctness             |
| 1.4-INT-004   | Integration | P0       | Location service integration            | GPS service boundary              |
| 1.4-E2E-002   | E2E         | P0       | GPS permission and location detection   | Critical user experience          |

#### AC3: Employee สามารถกด "Check-In" เพื่อบันทึกเวลาเริ่มงานได้

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.4-UNIT-005  | Unit        | P1       | Check-in button validation              | UI logic validation               |
| 1.4-INT-005   | Integration | P0       | Check-in API creates time_entry         | Database operation critical       |
| 1.4-E2E-003   | E2E         | P0       | Complete check-in workflow              | Revenue-critical user journey     |

#### AC4: Employee สามารถกด "Check-Out" เพื่อบันทึกเวลาเลิกงานได้

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.4-UNIT-006  | Unit        | P1       | Check-out button validation             | UI logic validation               |
| 1.4-INT-006   | Integration | P0       | Check-out API updates time_entry        | Database update critical          |
| 1.4-E2E-004   | E2E         | P0       | Complete check-out workflow             | Revenue-critical user journey     |

#### AC5: ระบบแสดงสถานะ check-in/check-out ปัจจุบันของ employee อย่างชัดเจน

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.4-UNIT-007  | Unit        | P1       | Status display logic validation         | UI state logic                    |
| 1.4-INT-007   | Integration | P1       | Status API returns correct state        | Service integration               |
| 1.4-E2E-005   | E2E         | P1       | UI displays accurate status             | User experience critical          |

#### AC6: ระบบป้องกันการ check-in ซ้ำถ้ายังไม่ได้ check-out จากครั้งก่อน

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.4-UNIT-008  | Unit        | P0       | Duplicate check-in validation logic     | Critical business rule            |
| 1.4-INT-008   | Integration | P0       | API prevents duplicate check-ins        | Data integrity critical           |
| 1.4-E2E-006   | E2E         | P1       | UI prevents double check-in             | User experience validation        |

#### AC7: ระบบบันทึกข้อมูลลงตาราง time_entries

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.4-UNIT-009  | Unit        | P1       | Time entry data structure validation    | Data model validation             |
| 1.4-INT-009   | Integration | P0       | Database persistence verification       | Data integrity critical           |

#### AC8: มีการแสดง error handling เมื่อไม่สามารถเข้าถึง GPS ได้หรือไม่มีสาขาในรัศมี

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.4-UNIT-010  | Unit        | P1       | GPS error handling logic                | Error handling validation         |
| 1.4-UNIT-011  | Unit        | P1       | No branches in radius error             | Edge case handling                |
| 1.4-INT-010   | Integration | P1       | GPS service error propagation           | Service error handling            |
| 1.4-E2E-007   | E2E         | P2       | GPS permission denied scenario          | User error experience             |
| 1.4-E2E-008   | E2E         | P2       | No branches available error UI          | User error experience             |

### Story 1.5: Selfie Capture Integration

#### AC1: Employee ต้องถ่ายเซลฟี่ก่อนการ check-in เสมอ (บังคับไม่สามารถข้ามได้)

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-001  | Unit        | P0       | Mandatory selfie validation logic       | Critical business rule            |
| 1.5-INT-011   | Integration | P0       | Check-in blocks without selfie          | Workflow integrity                |
| 1.5-E2E-009   | E2E         | P0       | UI enforces mandatory selfie            | Critical user journey             |

#### AC2: Employee ต้องถ่ายเซลฟี่ก่อนการ check-out เสมอ (บังคับไม่สามารถข้ามได้)

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-002  | Unit        | P0       | Mandatory checkout selfie validation    | Critical business rule            |
| 1.5-INT-012   | Integration | P0       | Check-out blocks without selfie         | Workflow integrity                |

#### AC3: ระบบต้องสามารถเข้าถึงกล้องหน้าของอุปกรณ์ได้ (request camera permission)

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-003  | Unit        | P1       | Camera permission request logic         | Permission handling logic         |
| 1.5-INT-013   | Integration | P1       | Camera service initialization           | Device integration                |
| 1.5-E2E-010   | E2E         | P0       | Camera permission grant/deny flow       | Critical user experience          |

#### AC4: รูปเซลฟี่ต้องถูก upload ไปยัง Supabase Storage อย่างปลอดภัย

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-004  | Unit        | P0       | File upload validation logic            | Data integrity critical           |
| 1.5-UNIT-005  | Unit        | P1       | File format and size validation         | Input validation                  |
| 1.5-INT-014   | Integration | P0       | Supabase Storage upload integration     | External service critical         |

#### AC5: ระบบต้องอัพเดต time_entries table ด้วย selfie URLs ที่เก็บไว้

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-006  | Unit        | P1       | Selfie URL update logic                 | Data model validation             |
| 1.5-INT-015   | Integration | P0       | Database URL field update               | Data integrity critical           |

#### AC6: แสดง preview รูปที่ถ่ายก่อน confirm การ check-in/check-out

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-007  | Unit        | P1       | Image preview display logic             | UI logic validation               |
| 1.5-E2E-011   | E2E         | P1       | Preview and confirm workflow            | User experience critical          |

#### AC7: มี retry mechanism หาก upload รูปไม่สำเร็จ

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-008  | Unit        | P1       | Retry logic with exponential backoff   | Algorithm correctness             |
| 1.5-INT-016   | Integration | P1       | Upload failure and retry handling       | Error recovery testing            |

#### AC8: ระบบจัดการ error cases: ไม่มีกล้อง, ปฏิเสธ camera permission, upload ล้มเหลว

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-009  | Unit        | P1       | Camera unavailable error handling       | Error handling logic              |
| 1.5-UNIT-010  | Unit        | P1       | Permission denied error handling        | Error handling logic              |
| 1.5-UNIT-011  | Unit        | P1       | Upload failure error handling           | Error handling logic              |
| 1.5-E2E-012   | E2E         | P2       | Complete error scenario testing         | User error experience             |

#### AC9: รูปที่เก็บไว้ต้องมีการกำหนด naming convention ที่ชัดเจน

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-012  | Unit        | P1       | Filename generation validation          | Data organization logic           |

#### AC10: ระบบต้องแสดงสถานะการ upload (uploading, success, failed) อย่างชัดเจน

| ID            | Level       | Priority | Test                                    | Justification                     |
| ------------- | ----------- | -------- | --------------------------------------- | --------------------------------- |
| 1.5-UNIT-013  | Unit        | P1       | Upload status indicator logic           | UI state logic                    |
| 1.5-E2E-013   | E2E         | P2       | Upload status UI feedback               | User experience validation        |

## Risk Coverage

### Critical Data Integrity Risks
- **RISK-001**: Time entry without valid selfie → Covered by 1.5-UNIT-001, 1.5-INT-011
- **RISK-002**: Duplicate check-ins → Covered by 1.4-UNIT-008, 1.4-INT-008
- **RISK-003**: GPS spoofing/manipulation → Covered by 1.4-UNIT-001, 1.4-INT-004

### Security and Privacy Risks
- **RISK-004**: Unauthorized access to selfies → Covered by 1.5-INT-014
- **RISK-005**: Camera permission bypass → Covered by 1.5-E2E-010

### User Experience Risks
- **RISK-006**: GPS not available → Covered by 1.4-E2E-007, 1.4-E2E-008
- **RISK-007**: Camera not available → Covered by 1.5-E2E-012

## Test Execution Priority Matrix

### P0 Tests (Execute First - Critical Path)
- GPS calculation and validation (1.4-UNIT-001, 1.4-UNIT-003)
- Database operations (1.4-INT-003, 1.4-INT-005, 1.4-INT-006)
- Mandatory selfie enforcement (1.5-UNIT-001, 1.5-UNIT-002)
- File upload integrity (1.5-UNIT-004, 1.5-INT-014)
- Complete workflows (1.4-E2E-003, 1.4-E2E-004, 1.5-E2E-009)

### P1 Tests (Core Functionality)
- Algorithm accuracy (1.4-UNIT-004, 1.5-UNIT-008)
- Service integrations (1.4-INT-007, 1.5-INT-013)
- User journey validation (1.4-E2E-001, 1.5-E2E-011)

### P2 Tests (Secondary Features)
- Error experience (1.4-E2E-007, 1.5-E2E-012)
- UI feedback (1.5-E2E-013)

### P3 Tests (Nice to Have)
- Edge case scenarios
- Performance optimization validation

## Recommended Execution Order

1. **P0 Unit tests** (fail fast) - 9 tests
2. **P0 Integration tests** - 8 tests  
3. **P0 E2E tests** - 5 tests
4. **P1 tests in order** - 14 tests
5. **P2+ as time permits** - 6 tests

## Test Environment Requirements

### Unit Test Environment
- Jest/Vitest with TypeScript support
- Mock camera APIs (MediaDevices)
- Mock GPS/location services
- Mock Supabase client

### Integration Test Environment
- Test database with realistic data
- Mock external services (Supabase Storage)
- Network request interception
- Time mocking capabilities

### E2E Test Environment
- Real browser with camera permissions
- GPS simulation capabilities
- Network condition simulation
- Visual regression testing setup

## Coverage Gap Analysis

**Areas requiring additional coverage:**
- Performance testing under load (file upload concurrency)
- Security penetration testing (file upload vulnerabilities)
- Accessibility testing for camera interfaces
- Cross-browser compatibility (especially mobile browsers)

**Coverage is sufficient for:**
- Business logic validation
- Critical user journeys
- Error handling scenarios
- Data integrity protection

## Success Criteria

### Pass Criteria
- All P0 tests must pass (100%)
- P1 tests >95% pass rate
- P2 tests >90% pass rate
- No critical security vulnerabilities identified

### Quality Gates
- Unit test coverage >90% for core logic
- Integration test coverage >80% for service boundaries
- E2E test coverage for all critical user journeys
- Performance benchmarks within acceptable limits

This comprehensive test design ensures robust validation of the employee check-in system while maintaining efficient test execution and clear priority focus.